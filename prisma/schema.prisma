// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String   @id @default(uuid())
  clerkUserId  String   @unique @map("clerk_user_id")
  email        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  stores Store[]
  
  @@map("users")
}

model Store {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  ebayStoreName   String?  @map("ebay_store_name")
  ebayUserId      String?  @map("ebay_user_id")
  ebayUsername    String?  @map("ebay_username")
  marketplaceId   String?  @map("marketplace_id") // e.g., EBAY_US
  merchantLocationKey String? @map("merchant_location_key") // inventory "warehouse" location key
  paymentPolicyId String?  @map("payment_policy_id")
  fulfillmentPolicyId String? @map("fulfillment_policy_id")
  returnPolicyId  String?  @map("return_policy_id")
  ebayAccessToken String?  @map("ebay_access_token")
  ebayRefreshToken String? @map("ebay_refresh_token")
  ebayTokenExpiry DateTime? @map("ebay_token_expiry")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  listings Listing[]
  dropListings DropListing[]
  
  @@map("stores")
}

model DropListing {
  id          String   @id @default(uuid())
  storeId     String   @map("store_id")
  status      String   @default("processing") // processing, needs_review, ready_to_publish, published, failed

  // Images are stored as Data URLs for MVP (works locally + on Vercel without external storage).
  // Keep images small (client resizes) to avoid DB bloat.
  images      String[]

  // Draft listing fields (AI-generated, then user editable)
  title       String?
  description String?  @db.Text
  categoryId  String?  @map("category_id")
  condition   String?
  price       Decimal? @db.Decimal(10, 2)
  quantity    Int      @default(1)
  sku         String?
  marketplaceId String? @map("marketplace_id")

  // AI debugging / provenance
  aiExtractedText String? @db.Text @map("ai_extracted_text")
  aiRaw           Json?   @map("ai_raw")
  aiNotes         String[] @map("ai_notes")
  error           String?

  // Link to a published Listing (optional)
  publishedListingId String? @unique @map("published_listing_id")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  publishedListing Listing? @relation("DropListingPublished", fields: [publishedListingId], references: [id], onDelete: SetNull)

  @@map("drop_listings")
}

model Listing {
  id            String   @id @default(uuid())
  storeId       String   @map("store_id")
  ebayOfferId   String?  @unique @map("ebay_offer_id")
  sku           String?  @map("sku")
  ebayItemId    String?  @unique @map("ebay_item_id")
  ebayListingId String?  @unique @map("ebay_listing_id") // returned from publish offer
  title         String
  description   String?  @db.Text
  price         Decimal? @db.Decimal(10, 2)
  quantity      Int      @default(1)
  status        String   @default("draft") // draft, active, sold, ended
  marketplaceId String?  @map("marketplace_id")
  categoryId    String?  @map("category_id")
  condition     String?
  images        String[] // Array of image URLs
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  listedAt      DateTime? @map("listed_at") // When actually listed on eBay
  
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  publishedDropListing DropListing? @relation("DropListingPublished")
  
  @@map("listings")
}
